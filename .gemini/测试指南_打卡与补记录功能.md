# 功能更新测试指南

## 更新内容

### 1. 打卡记录显示和统计

**已实现：**
- ✅ 打卡记录现在会显示在活动日志中，带有 [打卡] 标签
- ✅ 在 AI 教练的实时数据中，打卡记录会以 `[打卡] 习惯名称` 的格式显示
- ✅ 在生成日报时，打卡记录会被包含在活动日志明细中，格式为 `[打卡] 习惯名称 (时间)`
- ✅ 晚安时 AI 会检查"今日时间轴记录（包括打卡）"

**测试步骤：**
1. 点击任意打卡习惯的打卡按钮
2. 查看活动日志，应该看到带有 [打卡] 标签的记录
3. 对 AI 说"晚安"，查看 AI 的回复是否提到了打卡记录
4. 查看生成的日报，确认包含打卡记录

### 2. AI 协助补记录功能

**已实现：**
- ✅ 新增 `addSession` 工具，允许 AI 解析用户的自然语言输入
- ✅ AI 可以理解时间表述，如"4点到5点看书"、"上午写了2小时代码"
- ✅ 自动计算时长（从开始到结束时间）
- ✅ 智能匹配并关联相关待办任务
- ✅ 显示确认消息，包含时长和关联的待办信息

**测试步骤：**

#### 测试 1：基本补记录
```
用户：4点到5点看书
```
期望：AI 会添加一条"看书"的专注记录，时长为60分钟

#### 测试 2：自动关联待办
前提：先添加一个待办任务"写代码"
```
用户：今天上午10点到12点写了代码
```
期望：AI 会添加一条"写代码"的专注记录，时长为120分钟，并自动关联到"写代码"这个待办任务

#### 测试 3：不同的时间表述
```
用户：刚刚跑步了半小时
用户：下午3点开始工作，到现在（假设现在是5点）
用户：早上8点到9点开会
```
期望：AI 都能正确解析时间并创建相应的专注记录

## 技术实现细节

### 1. 打卡记录标识
- 使用 `session.type === 'checkin'` 来标识打卡记录
- 在不同显示场景中正确渲染：
  - 活动日志：显示 [打卡] 标签
  - AI 实时数据：格式为 `[打卡] 习惯名称`
  - 日报：格式为 `[打卡] 习惯名称 (时间)`

### 2. addSession 工具
**参数：**
- `label`: 活动描述（必填）
- `startTime`: 开始时间，ISO 格式（必填）
- `endTime`: 结束时间，ISO 格式（必填）
- `taskTitle`: 相关任务标题（可选）

**AI 处理流程：**
1. 解析用户输入的自然语言
2. 转换为标准的 ISO 时间格式
3. 调用 addSession 工具
4. 系统计算时长
5. 如果提供了 taskTitle，智能匹配待办任务
6. 创建专注记录并显示确认消息

### 3. 智能任务匹配
- 使用模糊匹配：双向包含检查（不区分大小写）
- 例如：用户说"写代码"，可以匹配到"完成代码重构"任务

## 注意事项

1. **时间格式**：AI 需要将用户输入的时间转换为 ISO 格式（YYYY-MM-DDTHH:mm:ss）
2. **当天日期**：如果用户没有指定日期，应该使用当天日期
3. **任务关联**：任务匹配是可选的，如果没有匹配的任务，记录仍然会被创建
4. **时长计算**：自动计算，用户不需要指定

## 示例对话

```
用户：早安 🌞
AI：早上好！今天打算做什么呢？

用户：我昨天4点到5点看书了，忘记记录了
AI：已为你添加专注记录：看书，时长 60 分钟
[系统显示：✓ 已添加专注记录]

用户：还有，下午2点到4点写了代码
AI：已为你添加专注记录：写代码，时长 120 分钟
[如果有"写代码"相关的待办，会显示已关联]

用户：查看我的活动日志
[在活动日志中可以看到这些补录的记录]

用户：晚安 🌙
AI：今天你完成了...（会提到所有的专注记录和打卡记录）
[系统自动生成日报，包含所有记录]
```

## 已修改的文件

1. `services/geminiService.ts`
   - 添加 `addSessionDeclaration` 工具定义
   - 更新系统提示，包含打卡记录说明和补记录指导
   - 修改日报生成逻辑，包含打卡记录

2. `App.tsx`
   - 添加 `addSession` 工具调用处理逻辑
   - 实现时长计算和任务自动关联

## 下一步改进建议

1. **更智能的时间解析**：支持更多的口语化表述，如"刚才"、"早上"、"傍晚"等
2. **批量补录**：支持一次性补录多条记录
3. **提醒功能**：AI 可以主动询问用户是否需要补录当天遗漏的记录
4. **统计分析**：基于补录的记录提供更深入的时间分析
